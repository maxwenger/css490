
\documentclass[12pt,a4paper]{article}
\usepackage{fullpage}
\usepackage[USenglish]{babel}
\usepackage{authblk}
\usepackage{hyperref}

\usepackage{listings}
\usepackage{xcolor}

\colorlet{punct}{red!60!black}
\definecolor{background}{HTML}{EEEEEE}
\definecolor{delim}{RGB}{20,105,176}
\colorlet{numb}{magenta!60!black}

\lstdefinelanguage{json}{
    basicstyle=\normalfont\ttfamily,
    numbers=left,
    numberstyle=\scriptsize,
    stepnumber=1,
    numbersep=8pt,
    showstringspaces=false,
    breaklines=true,
    frame=lines,
    backgroundcolor=\color{background},
    literate=
     *{0}{{{\color{numb}0}}}{1}
      {1}{{{\color{numb}1}}}{1}
      {2}{{{\color{numb}2}}}{1}
      {3}{{{\color{numb}3}}}{1}
      {4}{{{\color{numb}4}}}{1}
      {5}{{{\color{numb}5}}}{1}
      {6}{{{\color{numb}6}}}{1}
      {7}{{{\color{numb}7}}}{1}
      {8}{{{\color{numb}8}}}{1}
      {9}{{{\color{numb}9}}}{1}
      {:}{{{\color{punct}{:}}}}{1}
      {,}{{{\color{punct}{,}}}}{1}
      {\{}{{{\color{delim}{\{}}}}{1}
      {\}}{{{\color{delim}{\}}}}}{1}
      {[}{{{\color{delim}{[}}}}{1}
      {]}{{{\color{delim}{]}}}}{1},
}

\lstdefinelanguage{tableJson}{
    basicstyle=\normalfont\ttfamily,
    showstringspaces=false,
    breaklines=true,
    literate=
     *{0}{{{\color{numb}0}}}{1}
      {1}{{{\color{numb}1}}}{1}
      {2}{{{\color{numb}2}}}{1}
      {3}{{{\color{numb}3}}}{1}
      {4}{{{\color{numb}4}}}{1}
      {5}{{{\color{numb}5}}}{1}
      {6}{{{\color{numb}6}}}{1}
      {7}{{{\color{numb}7}}}{1}
      {8}{{{\color{numb}8}}}{1}
      {9}{{{\color{numb}9}}}{1}
      {:}{{{\color{punct}{:}}}}{1}
      {,}{{{\color{punct}{,}}}}{1}
      {\{}{{{\color{delim}{\{}}}}{1}
      {\}}{{{\color{delim}{\}}}}}{1}
      {[}{{{\color{delim}{[}}}}{1}
      {]}{{{\color{delim}{]}}}}{1},
}


\usepackage{todonotes}

% Remove section numbering
\setcounter{secnumdepth}{0}
% Remove paragraph indentation
\setlength{\parindent}{0cm}


\title{eBay Search Service}

\author{Isabel Giang}
\author{Maxwell Wenger}
\affil{CSS490 Group Y4}

\date{January 26, 2021}


\begin{document}
\maketitle
\setcounter{tocdepth}{2}
\tableofcontents

% Problem:
% EBay Search has gotten quite slow.  We were able to gain some time by adding
% an index to the Master DB, but we are worried about long term scaling.  We
% need to settle on a design for a SearchServce that would be used to search
% for Auctions by Keyword and/or Category (breadcrumb)

% Deliverables:
% Create a design document that explains how you would solve the search
% problem.  This document will be read by the various engineers in the company
% for evaluation of your approach,so your design needs to be understandable to
% them based on the document.

\section{Overview}
\subsection{Problem Statement}
In the last few months, eBay users have reported increasingly slow response
times from eBay's website when searching for auctions. Application log analysis
for the eBay Master Service has confirmed that our FindAuctions API for the
eBay Master service takes significantly longer to return a response when we
search for auctions using keywords. It also takes longer to search for a large
number of auctions.
\vspace{\baselineskip}
This is negatively impacting eBay's user experience for existing users and is
hindering the website's chances of being adopted by new users.

% State business problem
\vspace{\baselineskip}

Performing further analysis on the eBay Master service schema shows that the
FindAuctions API must scan the entire table to first find active auctions. Then
it must scan those active auctions to find auctions that have titles with the
keywords we are looking for.
\vspace{\baselineskip}
To solve this problem, we have created an additional search database that
contains only the necessary auction data required to for search functionality.
We have then indexed the database by both keyword and category.
\vspace{\baselineskip}
This speeds up the FindAuctions API enough to fix the poor user experience
temporarily, but this will not be enough as the company grows. The number of
records in the Auction table, and subsequently, the number of active auctions
will increase at an exponential rate.

\vspace{\baselineskip}

\subsection{Solution}
\subsection{Current Solution}
To partially address this problem, we have added an AuctionStatus index to the
Auction table so we can immediately access all active auctions instead of
search for all auctions every time we query with keywords. 

\vspace{\baselineskip}
This speeds up the FindAuctions API enough to fix the poor user experience
temporarily, but this will not be enough as the company grows. The number of
records in the Auction table, and subsequently, the number of active auctions
will increase at an exponential rate. 

\subsection{Next Steps}

To solve this, we want to create a separate search service as another step 
towards eBay's move to a microservice oriented architecture that will handle
searching for auctions by keyword and/or category.

\vspace{\baselineskip} 

We will call this new service 'AuctionSearch'. This search service will have
its own database that will only be externally accessible via its API.
\vspace{\baselineskip}

Whenever a new FindAuction API request is made, this service will perform
the required business logic and databases accesses instead of the eBay Master service.


% Clarify what kinds of searching we are doing such as:
% - Allow searching for only active auctions 
% - this one -> Allow searching for any auction.
% - Allow a bidder to find all of their active auctions
% - Administrator looking for a specific set of auctions that have expired
% - Etc

% Need Database Schema
 
\section{eBay Search Service API Specification}

\subsection{createSearchableAuction}
\label{ref:csa}
This creates an entry in the search database for the auction, all of the
auction's keywords, and the auction category.

\subsubsection{Input}
\begin{lstlisting}[language=json,firstnumber=1]
{
    "auctionKey": <string>,
    "title": <string>,
    "closeDate": <string>,
    "status": <string>,
    "breadcrumb": <string>
}
\end{lstlisting}

\subsubsection{Output}
\begin{center}
    \begin{tabular}{| p{5cm} | l |}
        \hline
        \textbf{Scenario} & \textbf{Response} \\
        \hline
        Successfully created search entry. & 
        \begin{lstlisting}[boxpos=t,language=tableJson,firstnumber=1]
{
    "success": true
}
        \end{lstlisting} \\ 
        \hline
            TODO: Make error states & Yeah! What he said! \\
        \hline
    \end{tabular}
\end{center}


\subsection{updateSearchableAuction}
\label{ref:usa}
Update searchable auction will update fields, keywords, and categories of an
existing auction in the search table. New keywords will be generated if a new
title is provided. The new keywords will be added to the database, and keywords
associated with they auction key but were not again generated from the updated
title will be removed from the database. The fields will be based on the
auction key, therefore the auction key may not be updated. Any optional fields
not included in the message to the service will not be changed.

\subsubsection{input}
\begin{lstlisting}[language=json,firstnumber=1]
{
    "auctionkey": <string>,
    "title": <string>, // optional
    "closedate": <string>, // optional
    "status": <string>, // optional
    "breadcrumb": <string> // optional
}
\end{lstlisting}

\subsubsection{output}
\begin{center}
    \begin{tabular}{| p{5cm} | l |}
        \hline
        \textbf{scenario} & \textbf{response} \\
        \hline
        successfully updated search entry. &
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": true
}
        \end{lstlisting} \\ 
        \hline
        provided auction key does not exist in the search database. & 
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": false,
    "exception": "auctionkeynotfound"
}
        \end{lstlisting} \\
        \hline
            todo: make error states & yeah! what he said! \\
        \hline
    \end{tabular}
\end{center}

\subsection{logging}

\begin{lstlisting}[boxpos=t,language=json,firstnumber=1]
{
    "start": <string>,
    "duration": <string>,
    "api": <string>,
    "params":
        {
            "original": {
                "auctionkey": <string>,
                "title": <string>, // optional
                "closedate": <string>, // optional
                "status": <string>, // optional
                "breadcrumb": <string> // optional 
            }, 
            "updated": {
                "auctionkey": <string>,
                "title": <string>, // optional
                "closedate": <string>, // optional
                "status": <string>, // optional
                "breadcrumb": <string> // optional 
            }
        }
}           
\end{lstlisting}

\begin{itemize}
    \item \textbf{start} The time the service first receives the call.
    \item \textbf{duration} The amount of time it takes from when the service
        receives the call to when the service responds.
    \item \textbf{api} The name of the API that is called.
    \item \textbf{params} The original and updated data that the API changed.
        Optional data that was not changed is not included in either the
        updated or original logs.
\end{itemize}



\subsection{findAuctions}
findAuctions will return a number of results based on the user's query. The
parameters search by ``anding'' the results together (e.g. if you ask for a
keyword ``red'', ``LG'' with the category ``ELE:PHO'' signifying phones in
electronics, red LG phones will be returned, but not red Nokia phones, or red
LG refrigerators). To perform searches that ``or'' search terms, multiple
searches must be made. lastAuctionKey and numResults are to be used for
pagination. findAuctions will return numResults number of entries ordered from
oldest to newest, starting from the lastAuctionKey. If no lastAuctionKey is
provided, findAuctions will return numResults number of results starting from
the first result.

\subsubsection{input}
\begin{lstlisting}[language=json,firstnumber=1]
{
    "keywords": [ <string>, ...], // optional
    "status": <string>, // optional
    "breadcrumb": <string>, // optional
    "lastAuctionKey": <string>, // optional
    "numresults": <string>
}
\end{lstlisting}

findAuctions will return a number of results based on the user's query. The
parameters search by ``anding'' the results together (e.g. if you ask for a
keyword ``red'', ``LG'' with the category ``ELE:PHO'' signifying phones in
electronics, red LG phones will be returned, but not red Nokia phones, or red
LG refrigerators). To perform searches that ``or'' search terms, multiple
searches must be made. lastAuctionKey and numResults are to be used for
pagination. findAuctions will return numResults number of entries ordered from
oldest to newest, starting from the lastAuctionKey. If no lastAuctionKey is
provided, findAuctions will return numResults number of results starting from
the first result.

\subsubsection{input}
\begin{lstlisting}[language=json,firstnumber=1]
{
    "keywords": [ <string>, ...], // optional
    "status": <string>, // optional
    "breadcrumb": <string>, // optional
    "lastAuctionKey": <string>, // optional
    "numresults": <string>
}
\end{lstlisting}

\subsubsection{output}
\begin{center}
    \begin{tabular}{| p{5cm} | l |}
        \hline
        \textbf{scenario} & \textbf{response} \\
        \hline
        Successfully search with found results. &
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": true,
    "results": [ auctionKey <string>, ...]
}
        \end{lstlisting} \\ 
        \hline
 \hline
        Successfully search with no results. &
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": true,
    "results": [ ]
}
        \end{lstlisting} \\ 
        \hline
            todo: make error states & yeah! what he said! \\
        \hline
    \end{tabular}
\end{center}


\subsubsection{output}
\begin{center}
    \begin{tabular}{| p{5cm} | l |}
        \hline
        \textbf{scenario} & \textbf{response} \\
        \hline
        Successfully search with found results. &
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": true,
    "results": [ auctionKey <string>, ...]
}
        \end{lstlisting} \\ 
        \hline
 \hline
        Successfully search with no results. &
        \begin{lstlisting}[boxpos=t,language=tablejson,firstnumber=1]
{
    "success": true,
    "results": [ ]
}
        \end{lstlisting} \\ 
        \hline
            todo: make error states & yeah! what he said! \\
        \hline
    \end{tabular}
\end{center}

\section{eBay Search Service Intervals}
% Describe what internal processes you do based on APIs.
% I.E. What happens to DB when xyz is called.


\section{Changes to eBay Master Service}

\subsection{createAuction}

Creates an auction as it did before, although now the createAuction service is
responsible for calling createSearchableAuction to create a search entry for
the auction.

The impact on the database from createAuction is documented in the master api
documentation. The impact on the database from createSearchableAuction is
documented in section \nameref{ref:csa}.

If three calls to the search service fails, the call will be queued up to be
attempted again with other failed calls at a regular interval.

% For any changes to the ebay master service, we need to provide:
% - Description of schema changes (not a full schema drawing)
% - Description of behavioral changes
%   - Describe new control  flow
%   - Describe transactional events
%   - Describe what happens on timeout from the search service.
% - Any additional API calls that are needed to be added to master service

\subsection{updateAuction}

Update auction will work as it did before. Except, now, update auction will
call updateSearchableAuction with the updated parameters it will receive.

The impact on the database from updateAuction is documented in the master api
documentation. The impact on the database from updateSearchableAuction is
documented in section \nameref{ref:usa}.

If three calls to the search service fails, the call will be queued up to be
attempted again with other failed calls at a regular interval.

\end{document}
